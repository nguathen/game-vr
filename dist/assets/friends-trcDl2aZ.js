import{a as r,i as c,d as f,b as u,s as C,f as g}from"./auth-manager-Cgi3t6lo.js";const w=20;class F{constructor(){this._friendProfiles=[]}generateFriendCode(){const n="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let s="";for(let e=0;e<6;e++)s+=n.charAt(Math.floor(Math.random()*n.length));return s}async ensureFriendCode(){const n=r.profile;if(n.friendCode)return n.friendCode;const s=this.generateFriendCode();if(await r.saveProfile({friendCode:s}),c&&r.user){const e=f(u,"friendCodes",s);await C(e,{uid:r.uid})}return s}async addFriend(n){const s=r.profile,e=s.friends||[];if(e.length>=w)return{success:!1,error:"Friend list full (max 20)"};if(n===s.friendCode)return{success:!1,error:"You can't add yourself"};if(!c)return{success:!1,error:"Friends require online mode"};const t=f(u,"friendCodes",n.toUpperCase()),i=await g(t);if(!i.exists())return{success:!1,error:"Friend code not found"};const d=i.data().uid;return e.includes(d)?{success:!1,error:"Already friends"}:(e.push(d),await r.saveProfile({friends:e}),{success:!0})}async removeFriend(n){const e=(r.profile.friends||[]).filter(t=>t!==n);await r.saveProfile({friends:e})}async getFriendProfiles(){var t,i;const s=r.profile.friends||[];if(s.length===0||!c)return[];const e=[];for(const d of s)try{const p=f(u,"players",d),y=await g(p);if(y.exists()){const a=y.data(),h=((i=(t=a.lastSeen)==null?void 0:t.toDate)==null?void 0:i.call(t))||null,E=h&&Date.now()-h.getTime()<300*1e3;e.push({uid:d,displayName:a.displayName||"Player",level:a.level||1,highScores:a.highScores||{},isOnline:E})}}catch{}return this._friendProfiles=e,e}getCachedFriends(){return this._friendProfiles}}const l=new F;async function L(){const o=document.getElementById("transition");if(o.classList.add("active"),requestAnimationFrame(()=>o.classList.remove("active")),!c){document.getElementById("offline-msg").classList.remove("hidden"),document.getElementById("btn-back").addEventListener("click",()=>{window.location.href="./index.html"});return}const n=await l.ensureFriendCode();document.getElementById("my-code").textContent=n,document.getElementById("btn-copy-code").addEventListener("click",()=>{navigator.clipboard.writeText(n).then(()=>{document.getElementById("btn-copy-code").textContent="Copied!",setTimeout(()=>{document.getElementById("btn-copy-code").textContent="Copy"},2e3)})}),document.getElementById("btn-add-friend").addEventListener("click",async()=>{const s=document.getElementById("friend-code-input"),e=document.getElementById("add-result"),t=s.value.trim().toUpperCase();if(!t||t.length<4){e.textContent="Enter a valid code",e.style.color="#ff4444";return}const i=await l.addFriend(t);i.success?(e.textContent="Friend added!",e.style.color="#00ff88",s.value="",await m()):(e.textContent=i.error,e.style.color="#ff4444"),setTimeout(()=>{e.textContent=""},3e3)}),await m(),document.getElementById("btn-back").addEventListener("click",()=>{o.classList.add("active"),setTimeout(()=>{window.location.href="./index.html"},300)})}async function m(){const o=document.getElementById("friend-list"),n=document.getElementById("friend-count"),s=document.getElementById("no-friends"),e=await l.getFriendProfiles();if(n.textContent=e.length,e.length===0){s.classList.remove("hidden");return}s.classList.add("hidden"),o.querySelectorAll(".friend-row").forEach(t=>t.remove()),e.forEach(t=>{const i=document.createElement("div");i.className="friend-row";const d=Math.max(0,...Object.values(t.highScores||{}));i.innerHTML=`
      <span class="friend-status ${t.isOnline?"online":""}"></span>
      <span class="friend-name">${x(t.displayName)}</span>
      <span class="friend-level">Lv.${t.level}</span>
      <span class="friend-score">${d}</span>
      <button class="btn-remove" data-uid="${t.uid}">x</button>
    `,i.querySelector(".btn-remove").addEventListener("click",async()=>{await l.removeFriend(t.uid),await m()}),o.appendChild(i)})}function x(o){const n=document.createElement("div");return n.textContent=o,n.innerHTML}let v=!1;r.waitReady().then(()=>{const o=()=>{v||(v=!0,L())};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",o):o()});
