import{a as r}from"./auth-manager-Cgi3t6lo.js";const o=[{id:"coin_pack_100",sku:"coin_pack_100",name:"100 Coins",description:"A handful of coins",price:.99,type:"consumable",coinAmount:100},{id:"coin_pack_500",sku:"coin_pack_500",name:"500 Coins",description:"A bag of coins â€” best value!",price:3.99,type:"consumable",coinAmount:500},{id:"premium_unlock",sku:"premium_unlock",name:"Premium",description:"Unlock extra targets & themes",price:4.99,type:"non_consumable"}],n="https://store.meta.com/billing";class u{constructor(){this._products=o,this._service=null,this._devMode=!1,this._ready=!1}get products(){return this._products}get devMode(){return this._devMode}get ready(){return this._ready}async init(){try{if(!window.getDigitalGoodsService)throw new Error("Digital Goods API not available");this._service=await window.getDigitalGoodsService(n),await this._restoreEntitlements(),await this._fetchPrices()}catch(e){console.warn("[IAPManager] Falling back to dev mode:",e.message),this._devMode=!0}this._ready=!0}async _fetchPrices(){if(!this._service)return;const e=this._products.map(t=>t.sku);try{const t=await this._service.getDetails(e);for(const s of t){const i=this._products.find(a=>a.sku===s.itemId);i&&(i.metaPrice=s.price,i.metaTitle=s.title)}}catch(t){console.warn("[IAPManager] Failed to fetch prices:",t.message)}}async _restoreEntitlements(){if(this._service)try{const e=await this._service.listPurchases();for(const t of e){const s=this._products.find(i=>i.sku===t.itemId);s&&s.type==="non_consumable"&&await this._grantProduct(s)}}catch(e){console.warn("[IAPManager] Failed to restore entitlements:",e.message)}}async purchase(e){const t=this._products.find(s=>s.id===e);if(!t)throw new Error(`Product not found: ${e}`);return this._devMode?this._devPurchase(t):this._metaPurchase(t)}async _metaPurchase(e){const t=[{supportedMethods:n,data:{sku:e.sku}}],s={total:{label:e.name,amount:{currency:"USD",value:e.price.toString()}}},a=await new PaymentRequest(t,s).show(),{purchaseToken:c}=a.details;return await this._grantProduct(e),e.type==="consumable"&&this._service&&await this._service.consume(c),await a.complete("success"),{success:!0,product:e}}async _devPurchase(e){try{const t=await fetch("/api/checkout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({productId:e.id})});t.ok&&await t.json()}catch{}return await this._grantProduct(e),{success:!0,product:e,devMode:!0}}async _grantProduct(e){const t=r.profile;if(t){if(e.type==="consumable")await r.saveProfile({coins:(t.coins||0)+(e.coinAmount||0)});else if(e.type==="non_consumable"){const s=t.purchasedItems||[];if(s.includes(e.id))return;const a={purchasedItems:[...s,e.id]};e.id==="premium_unlock"&&(a.isPremium=!0),await r.saveProfile(a)}}}getDisplayPrice(e){return e.metaPrice?e.metaPrice:`$${e.price.toFixed(2)}`}isOwned(e){var s;return(((s=r.profile)==null?void 0:s.purchasedItems)||[]).includes(e)}}const l=new u;export{l as i};
