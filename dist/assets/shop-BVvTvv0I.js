import{a as p}from"./auth-manager-DjZ92ISH.js";import{g as r}from"./game-manager-CB7B5o80.js";const y=[{id:"coin_pack_100",sku:"coin_pack_100",name:"100 Coins",description:"A handful of coins",price:.99,type:"consumable",coinAmount:100},{id:"coin_pack_500",sku:"coin_pack_500",name:"500 Coins",description:"A bag of coins â€” best value!",price:3.99,type:"consumable",coinAmount:500},{id:"premium_unlock",sku:"premium_unlock",name:"Premium",description:"Unlock extra targets & themes",price:4.99,type:"non_consumable"}],_="https://store.meta.com/billing";class w{constructor(){this._products=y,this._service=null,this._devMode=!1,this._ready=!1}get products(){return this._products}get devMode(){return this._devMode}get ready(){return this._ready}async init(){try{if(!window.getDigitalGoodsService)throw new Error("Digital Goods API not available");this._service=await window.getDigitalGoodsService(_),console.log("[IAPManager] Digital Goods API connected"),await this._restoreEntitlements(),await this._fetchPrices()}catch(e){console.warn("[IAPManager] Falling back to dev mode:",e.message),this._devMode=!0}this._ready=!0}async _fetchPrices(){if(!this._service)return;const e=this._products.map(n=>n.sku);try{const n=await this._service.getDetails(e);for(const t of n){const i=this._products.find(a=>a.sku===t.itemId);i&&(i.metaPrice=t.price,i.metaTitle=t.title)}console.log("[IAPManager] Prices fetched from Meta")}catch(n){console.warn("[IAPManager] Failed to fetch prices:",n.message)}}async _restoreEntitlements(){if(this._service)try{const e=await this._service.listPurchases();for(const n of e){const t=this._products.find(i=>i.sku===n.itemId);t&&t.type==="non_consumable"&&(r.addPurchase(t.id),t.id==="premium_unlock"&&r.setPremium(!0),console.log(`[IAPManager] Restored entitlement: ${t.id}`))}}catch(e){console.warn("[IAPManager] Failed to restore entitlements:",e.message)}}async purchase(e){const n=this._products.find(t=>t.id===e);if(!n)throw new Error(`Product not found: ${e}`);return this._devMode?this._devPurchase(n):this._metaPurchase(n)}async _metaPurchase(e){const n=[{supportedMethods:_,data:{sku:e.sku}}],t={total:{label:e.name,amount:{currency:"USD",value:e.price.toString()}}},a=await new PaymentRequest(n,t).show(),{purchaseToken:c}=a.details;return this._grantProduct(e),e.type==="consumable"&&this._service&&await this._service.consume(c),await a.complete("success"),{success:!0,product:e}}async _devPurchase(e){console.log(`[IAPManager] Dev purchase: ${e.id}`);try{const n=await fetch("/api/checkout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({productId:e.id})});n.ok&&await n.json()}catch{}return this._grantProduct(e),{success:!0,product:e,devMode:!0}}_grantProduct(e){e.type==="consumable"?r.addCoins(e.coinAmount):e.type==="non_consumable"&&(r.addPurchase(e.id),e.id==="premium_unlock"&&r.setPremium(!0))}getDisplayPrice(e){return e.metaPrice?e.metaPrice:`$${e.price.toFixed(2)}`}isOwned(e){return r.hasPurchased(e)}}const d=new w;function v(o){const e=document.getElementById("transition");e?(e.classList.add("active"),setTimeout(()=>{window.location.href=o},300)):window.location.href=o}async function g(){const o=document.getElementById("shop-coins"),e=document.getElementById("product-list"),n=p.profile;o.textContent=`Coins: ${(n==null?void 0:n.coins)||0}`,e.textContent="Loading products...",await d.init(),e.textContent="",d.products.forEach(t=>{const i=document.createElement("div");i.className="product-item";const a=t.type==="non_consumable"&&d.isOwned(t.id),c=document.createElement("div");c.className="product-info";const l=document.createElement("div");l.className="product-name",l.textContent=t.name;const u=document.createElement("div");u.className="product-desc",u.textContent=t.description,c.appendChild(l),c.appendChild(u);const m=d.getDisplayPrice(t),s=document.createElement("button");s.className="btn-buy",s.disabled=a,s.textContent=a?"Owned":m,a||s.addEventListener("click",async()=>{var f;s.disabled=!0,s.textContent="...";try{await d.purchase(t.id),o.textContent=`Coins: ${((f=p.profile)==null?void 0:f.coins)||0}`,t.type==="non_consumable"?(s.textContent="Owned",h(`Unlocked: ${t.name}`,"success")):(s.disabled=!1,s.textContent=m,h(`+${t.coinAmount} coins!`,"success"))}catch{s.disabled=!1,s.textContent=m,h("Purchase failed. Try again.","error")}}),i.appendChild(c),i.appendChild(s),e.appendChild(i)}),document.getElementById("btn-back").addEventListener("click",()=>{v("./index.html")})}function h(o,e="info"){const n=document.querySelector(".notification");n&&n.remove();const t=document.createElement("div");t.className=`notification notification-${e}`,t.textContent=o,document.body.appendChild(t),setTimeout(()=>t.classList.add("show"),10),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>t.remove(),300)},3e3)}p.waitReady().then(()=>{document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g):g()});
