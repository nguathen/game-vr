import{a as p,i as re,d as Se,b as ae,s as Ae,c as Me,e as xe,q as Ee,o as ke,l as Ie,g as Le}from"./auth-manager-DjZ92ISH.js";import{g as U,G as Y}from"./game-manager-CB7B5o80.js";import{a as _}from"./audio-manager-BoM9ZqFN.js";import{w as q,g as A}from"./weapon-system-BnhBiZik.js";class $e{constructor(){this._score=0,this._shotsFired=0,this._listeners=[]}get score(){return this._score}reset(){this._score=0,this._shotsFired=0,this._notify()}recordShot(){this._shotsFired++}add(e){this._score+=e,this._notify()}finalize(){return{score:this._score,shotsFired:this._shotsFired}}onChange(e){this._listeners.push(e)}_notify(){this._listeners.forEach(e=>e(this._score))}}const H=new $e,ne={volume:80,sfx:!0,vibration:50,crosshairSize:"medium",crosshairColor:"#00ff88",highContrast:!1,reducedMotion:!1,autoSubmitScore:!0,showCombo:!0};function fe(){try{const o=localStorage.getItem("vr_quest_player_v2");if(o){const e=JSON.parse(o);return{...ne,...e.settings||{}}}}catch{}return{...ne}}const Oe=10,G={x:12,yMin:1,yMax:4,zMin:-14,zMax:-3},ce=["#e94560","#ff6b6b","#ffa502","#2ed573","#1e90ff","#a855f7","#ff69b4"],K={standard:{weight:50,points:10,radius:.3,geometry:"a-sphere",color:null,hp:1,speed:0,lifetime:null,coins:0},speed:{weight:20,points:25,radius:.22,geometry:"a-sphere",color:"#ffdd00",hp:1,speed:2.5,lifetime:null,coins:0},heavy:{weight:15,points:30,radius:.4,geometry:"a-box",color:"#ff3333",hp:2,speed:0,lifetime:null,coins:0},bonus:{weight:8,points:50,radius:.25,geometry:"a-sphere",color:"#ffd700",hp:1,speed:0,lifetime:2e3,coins:5},decoy:{weight:7,points:-10,radius:.3,geometry:"a-sphere",color:"#882222",hp:1,speed:0,lifetime:null,coins:0}};class Ne{constructor(e,t={}){this._container=e,this._targets=new Set,this._spawnTimer=null,this._running=!1,this._combo=0,this._comboTimer=null,this._onComboChange=null,this._onMiss=null,this._targetsHit=0,this._bestCombo=0,this._spawnInterval=t.spawnInterval||1500,this._maxTargets=t.maxTargets||8,this._targetLifetime=t.targetLifetime||5e3,this._bossMode=t.bossMode||!1,this._wave=0,this._coinsEarned=0}set onComboChange(e){this._onComboChange=e}set onMiss(e){this._onMiss=e}get targetsHit(){return this._targetsHit}get bestCombo(){return this._bestCombo}get coinsEarned(){return this._coinsEarned}configure(e){this._spawnInterval=e.spawnInterval||this._spawnInterval,this._maxTargets=e.maxTargets||this._maxTargets,this._targetLifetime=e.targetLifetime||this._targetLifetime,this._bossMode=e.bossMode||!1,this._wave=0,this._coinsEarned=0}start(){this._running=!0,this._combo=0,this._targetsHit=0,this._bestCombo=0,this._coinsEarned=0,this._wave=0,this._clearAll(),this._spawnTimer=setInterval(()=>this._trySpawn(),this._spawnInterval);for(let e=0;e<3;e++)this._spawnTarget()}stop(){this._running=!1,this._spawnTimer&&(clearInterval(this._spawnTimer),this._spawnTimer=null),this._clearAll()}_trySpawn(){!this._running||this._targets.size>=this._maxTargets||this._spawnTarget()}_pickTargetType(){if(this._bossMode)return"heavy";let e=0;for(const s of Object.values(K))e+=s.weight;let t=Math.random()*e;for(const[s,i]of Object.entries(K))if(t-=i.weight,t<=0)return s;return"standard"}_spawnTarget(){const e=this._pickTargetType(),t=K[e],s=document.createElement(t.geometry);if(s.setAttribute("class","target"),t.geometry==="a-box"){const m=t.radius*2;s.setAttribute("width",String(m)),s.setAttribute("height",String(m)),s.setAttribute("depth",String(m))}else s.setAttribute("radius",String(t.radius));const i=t.color||this._randomColor();s.setAttribute("material",`shader: flat; color: ${i}`);const r=this._bossMode?t.hp+Math.floor(this._wave/3):t.hp;s.setAttribute("target-hit",`hp: ${r}; targetType: ${e}`);const l=this._rand(-12,G.x),n=this._rand(G.yMin,G.yMax),h=this._rand(G.zMin,G.zMax);if(s.setAttribute("position",`${l} ${n} ${h}`),s.setAttribute("animation__spawn",{property:"scale",from:"0 0 0",to:"1 1 1",dur:300,easing:"easeOutElastic"}),!fe().reducedMotion)if(t.speed>0){const m=t.speed;s.setAttribute("animation__move",{property:"position",to:`${l+m} ${n} ${h}`,dur:800+Math.random()*400,easing:"easeInOutSine",loop:!0,dir:"alternate"})}else s.setAttribute("animation__float",{property:"position",to:`${l} ${n+.3} ${h}`,dur:1200+Math.random()*600,easing:"easeInOutSine",loop:!0,dir:"alternate"});s._targetType=e,s._targetPoints=t.points,s._targetCoins=t.coins,s.addEventListener("destroyed",m=>{var w,M;const y=((w=m==null?void 0:m.detail)==null?void 0:w.damage)||1,T=((M=m==null?void 0:m.detail)==null?void 0:M.position)||null;this._onTargetHit(s,y,T)});const f=t.lifetime||this._targetLifetime,u=setTimeout(()=>{this._targets.has(s)&&this._removeTarget(s,!0)},f);s._expireTimeout=u,this._container.appendChild(s),this._targets.add(s),_.playSpawn()}_onTargetHit(e,t=1,s=null){var n,h;if(!this._running)return;const i=e._targetPoints!==void 0?e._targetPoints:Oe,r=e._targetType==="decoy",l=s||{x:0,y:2,z:-5};if(r)H.add(i),this._combo=0,(n=this._onComboChange)==null||n.call(this,0),_.playMiss(),this._spawnDamageNumber(l,i,"#ff4444",""),this._flashScreen("miss");else{this._combo++,this._targetsHit++,this._wave++,this._combo>this._bestCombo&&(this._bestCombo=this._combo),this._comboTimer&&clearTimeout(this._comboTimer),this._comboTimer=setTimeout(()=>{var y;this._combo=0,(y=this._onComboChange)==null||y.call(this,0)},2e3);const c=Math.min(this._combo,5),f=i*c*t;H.add(f),(h=this._onComboChange)==null||h.call(this,this._combo),_.playHit(),this._combo>=2&&_.playCombo(this._combo);const u=c>1?` x${c}`:"",m=e._targetType==="bonus"?"#ffd700":c>1?"#00d4ff":"#ffffff";if(this._spawnDamageNumber(l,f,m,u),this._flashScreen("hit"),e._targetCoins>0){this._coinsEarned+=e._targetCoins;const y=p.profile;y&&p.saveProfile({coins:(y.coins||0)+e._targetCoins})}}this._targets.delete(e),e._expireTimeout&&clearTimeout(e._expireTimeout)}_spawnDamageNumber(e,t,s,i){const r=this._container.sceneEl||this._container.closest("a-scene");if(!r)return;const l=t>=0?`+${t}${i}`:`${t}`,n=document.createElement("a-entity");n.setAttribute("position",`${e.x} ${e.y+.3} ${e.z}`),n.setAttribute("damage-number",`text: ${l}; color: ${s}`),r.appendChild(n)}_flashScreen(e){let t=document.getElementById("hit-flash");t||(t=document.createElement("div"),t.id="hit-flash",t.className="hit-flash",document.body.appendChild(t)),t.className="hit-flash",t.offsetWidth,t.classList.add(e==="miss"?"flash-miss":"flash-hit"),setTimeout(()=>t.classList.remove("flash-hit","flash-miss"),100)}_removeTarget(e,t=!1){var s,i;this._targets.delete(e),e._expireTimeout&&clearTimeout(e._expireTimeout),t?(this._combo=0,(s=this._onComboChange)==null||s.call(this,0),_.playMiss(),(i=this._onMiss)==null||i.call(this),e.setAttribute("animation__fade",{property:"material.opacity",to:0,dur:200}),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},250)):e.parentNode&&e.parentNode.removeChild(e)}_clearAll(){this._targets.forEach(e=>{e._expireTimeout&&clearTimeout(e._expireTimeout),e.parentNode&&e.parentNode.removeChild(e)}),this._targets.clear()}_randomColor(){return ce[Math.floor(Math.random()*ce.length)]}_rand(e,t){return Math.random()*(t-e)+e}}const le="vr_quest_leaderboard_cache",He=20;class Pe{constructor(){this._cache=this._loadCache()}async submitScore(e,t){var r;if(!re||!p.user)return;const s=p.uid,i=Se(ae,"leaderboards",e,"scores",s);await Ae(i,{uid:s,displayName:p.displayName,score:t,level:((r=p.profile)==null?void 0:r.level)||1,timestamp:Me()},{merge:!0})}async getTopScores(e,t=He){if(!re)return this._cache[e]||[];try{const s=xe(ae,"leaderboards",e,"scores"),i=Ee(s,ke("score","desc"),Ie(t)),r=await Le(i),l=[];return r.forEach(n=>l.push({id:n.id,...n.data()})),this._cache[e]=l,this._saveCache(),l}catch{return this._cache[e]||[]}}_loadCache(){try{const e=localStorage.getItem(le);return e?JSON.parse(e):{}}catch{return{}}}_saveCache(){try{localStorage.setItem(le,JSON.stringify(this._cache))}catch{}}}const Xe=new Pe,ge=[{id:"score500_ta",description:"Score 500+ in Time Attack",type:"score",mode:"timeAttack",target:500,rewardXp:100,rewardCoins:20},{id:"hit50",description:"Hit 50 targets in one session",type:"targetsHit",target:50,rewardXp:75,rewardCoins:15},{id:"combo5",description:"Get a x5 combo",type:"combo",target:5,rewardXp:80,rewardCoins:15},{id:"play3",description:"Play 3 games today",type:"gamesPlayed",target:3,rewardXp:50,rewardCoins:10},{id:"score200_sniper",description:"Score 200+ with Sniper",type:"scoreWeapon",weapon:"sniper",target:200,rewardXp:120,rewardCoins:25},{id:"survive300",description:"Score 300+ in Survival",type:"score",mode:"survival",target:300,rewardXp:150,rewardCoins:30},{id:"hit100_total",description:"Hit 100 targets today",type:"totalHitsToday",target:100,rewardXp:100,rewardCoins:20},{id:"combo8",description:"Get a x8 combo",type:"combo",target:8,rewardXp:120,rewardCoins:25},{id:"play5",description:"Play 5 games today",type:"gamesPlayed",target:5,rewardXp:80,rewardCoins:15},{id:"score1000_ta",description:"Score 1000+ in Time Attack",type:"score",mode:"timeAttack",target:1e3,rewardXp:200,rewardCoins:50}];function qe(){const o=new Date;return`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`}function Fe(){const o=new Date;return(o.getFullYear()*1e4+(o.getMonth()+1)*100+o.getDate())%ge.length}function ye(){return ge[Fe()]}function Ge(){const o=p.profile,e=o==null?void 0:o.dailyChallenge,t=qe();return e&&e.date===t?e:{id:ye().id,date:t,progress:0,completed:!1,hitsToday:0,gamesPlayedToday:0}}async function Be(o){const e=ye(),t=Ge();if(t.completed)return{challenge:e,state:t,justCompleted:!1};t.hitsToday=(t.hitsToday||0)+(o.targetsHit||0),t.gamesPlayedToday=(t.gamesPlayedToday||0)+1;let s=0;switch(e.type){case"score":s=!e.mode||o.mode===e.mode?o.score:0,t.progress=Math.max(t.progress,s);break;case"scoreWeapon":s=o.weapon===e.weapon?o.score:0,t.progress=Math.max(t.progress,s);break;case"targetsHit":s=o.targetsHit||0,t.progress=Math.max(t.progress,s);break;case"combo":s=o.bestCombo||0,t.progress=Math.max(t.progress,s);break;case"gamesPlayed":t.progress=t.gamesPlayedToday;break;case"totalHitsToday":t.progress=t.hitsToday;break}const i=!t.completed&&t.progress>=e.target;if(i){t.completed=!0,await p.addXp(e.rewardXp);const r=p.profile;await p.saveProfile({coins:(r.coins||0)+e.rewardCoins})}return await p.saveProfile({dailyChallenge:t}),{challenge:e,state:t,justCompleted:i}}const Re=[{id:"first_blood",name:"First Blood",description:"Hit your first target",icon:"ðŸŽ¯",rewardXp:10,check:o=>o.totalTargetsHit>=1},{id:"sharpshooter",name:"Sharpshooter",description:"Get a x10 combo",icon:"ðŸ”¥",rewardXp:50,check:o=>o.bestCombo>=10},{id:"centurion",name:"Centurion",description:"Hit 100 total targets",icon:"ðŸ’¯",rewardXp:25,check:o=>o.totalTargetsHit>=100},{id:"marksman",name:"Marksman",description:"Score 1000 in Time Attack",icon:"ðŸ†",rewardXp:50,check:o=>{var e;return(((e=o.highScores)==null?void 0:e.timeAttack)||0)>=1e3}},{id:"survivor",name:"Survivor",description:"Score 500 in Survival",icon:"â¤ï¸",rewardXp:50,check:o=>{var e;return(((e=o.highScores)==null?void 0:e.survival)||0)>=500}},{id:"zen_master",name:"Zen Master",description:"Play 10 games",icon:"ðŸ§˜",rewardXp:30,check:o=>o.gamesPlayed>=10},{id:"arsenal",name:"Arsenal",description:"Reach level 5 (unlock all weapons)",icon:"ðŸ”«",rewardXp:100,check:o=>o.level>=5},{id:"veteran",name:"Veteran",description:"Play 50 games",icon:"â­",rewardXp:75,check:o=>o.gamesPlayed>=50},{id:"level10",name:"Level 10",description:"Reach level 10",icon:"ðŸ‘‘",rewardXp:100,check:o=>o.level>=10},{id:"boss_slayer",name:"Boss Slayer",description:"Score 300 in Boss Rush",icon:"ðŸ‘¹",rewardXp:100,check:o=>{var e;return(((e=o.highScores)==null?void 0:e.bossRush)||0)>=300}},{id:"combo_king",name:"Combo King",description:"Get a x15 combo",icon:"âš¡",rewardXp:75,check:o=>o.bestCombo>=15},{id:"five_hundred",name:"Five Hundred",description:"Hit 500 total targets",icon:"ðŸŽ–ï¸",rewardXp:50,check:o=>o.totalTargetsHit>=500},{id:"thousand",name:"Thousand",description:"Hit 1000 total targets",icon:"ðŸ…",rewardXp:100,check:o=>o.totalTargetsHit>=1e3},{id:"level20",name:"Legend",description:"Reach level 20",icon:"ðŸ’Ž",rewardXp:200,check:o=>o.level>=20},{id:"dedicated",name:"Dedicated",description:"Play 100 games",icon:"ðŸŽ®",rewardXp:100,check:o=>o.gamesPlayed>=100}];async function Ve(){const o=p.profile;if(!o)return[];const e=o.achievements||[],t=[];for(const s of Re)e.includes(s.id)||s.check(o)&&(t.push(s),e.push(s.id));if(t.length>0){await p.saveProfile({achievements:e});let s=0;for(const i of t)s+=i.rewardXp;s>0&&await p.addXp(s)}return t}const de={cyber:{id:"cyber",name:"Cyber Arena",icon:"ðŸ’Ž",unlockLevel:1,sky:"#0a0a1a",floor:"#111133",grid:"#1a1a4e",gridOpacity:.3,lights:[{type:"ambient",color:"#222244",intensity:.4},{type:"point",position:"0 10 0",color:"#4466ff",intensity:1.2,distance:40},{type:"point",position:"-8 6 -8",color:"#ff4444",intensity:.6,distance:25},{type:"point",position:"8 6 -8",color:"#44ff44",intensity:.6,distance:25},{type:"point",position:"0 4 8",color:"#ff88ff",intensity:.4,distance:20}],pillarColor:"#1a1a4e",wallColor:"#0044aa"},sunset:{id:"sunset",name:"Sunset Range",icon:"ðŸŒ…",unlockLevel:3,sky:"#1a0a05",floor:"#2a1a0a",grid:"#3a2a1a",gridOpacity:.2,lights:[{type:"ambient",color:"#442211",intensity:.5},{type:"point",position:"0 10 0",color:"#ff8844",intensity:1,distance:40},{type:"point",position:"-8 6 -8",color:"#ff6622",intensity:.5,distance:25},{type:"point",position:"8 6 -8",color:"#ffaa44",intensity:.5,distance:25},{type:"point",position:"0 4 8",color:"#ff4400",intensity:.3,distance:20}],pillarColor:"#3a2211",wallColor:"#663311"},space:{id:"space",name:"Deep Space",icon:"ðŸŒŒ",unlockLevel:6,sky:"#020208",floor:"#0a0a15",grid:"#111133",gridOpacity:.15,lights:[{type:"ambient",color:"#111122",intensity:.3},{type:"point",position:"0 10 0",color:"#2244ff",intensity:1,distance:40},{type:"point",position:"-8 6 -8",color:"#4488ff",intensity:.4,distance:25},{type:"point",position:"8 6 -8",color:"#2266cc",intensity:.4,distance:25},{type:"point",position:"0 4 8",color:"#6644ff",intensity:.3,distance:20}],pillarColor:"#0a0a2e",wallColor:"#112244"},neon:{id:"neon",name:"Neon City",icon:"ðŸ™ï¸",unlockLevel:10,sky:"#050510",floor:"#0a0a20",grid:"#220044",gridOpacity:.4,lights:[{type:"ambient",color:"#110022",intensity:.3},{type:"point",position:"0 10 0",color:"#ff00ff",intensity:1.2,distance:40},{type:"point",position:"-8 6 -8",color:"#00ffff",intensity:.7,distance:25},{type:"point",position:"8 6 -8",color:"#ff0088",intensity:.7,distance:25},{type:"point",position:"0 4 8",color:"#00ff88",intensity:.4,distance:20}],pillarColor:"#220044",wallColor:"#440088"}};function De(o,e){const t=de[e]||de.cyber,s=o.querySelector("a-sky");s&&s.setAttribute("color",t.sky);const i=o.querySelectorAll("#game-scene > a-plane");i[0]&&i[0].setAttribute("material",`color: ${t.floor}; wireframe: false`);const r=o.querySelector("#floor-grid a-plane");r&&r.setAttribute("material",`color: ${t.grid}; wireframe: true; wireframeLinewidth: 1; opacity: ${t.gridOpacity}`),o.querySelectorAll("#game-scene > a-box").forEach(c=>{c.setAttribute("material",`color: ${t.wallColor}; opacity: 0.15; shader: flat`)}),o.querySelectorAll("#game-scene > a-cylinder").forEach(c=>{c.setAttribute("color",t.pillarColor),c.setAttribute("material","shader: flat; opacity: 0.5")}),o.querySelectorAll("#game-scene > a-light").forEach((c,f)=>{if(f<t.lights.length){const u=t.lights[f];c.setAttribute("type",u.type),c.setAttribute("color",u.color),c.setAttribute("intensity",String(u.intensity)),u.position&&c.setAttribute("position",u.position),u.distance&&c.setAttribute("distance",String(u.distance))}})}const ze={default:{id:"default",name:"Default",laserColor:null,laserOpacity:null,burstColor:null,unlockType:"free",unlockValue:0},fire:{id:"fire",name:"Fire",laserColor:"#ff4400",laserOpacity:.8,burstColor:"#ff6600",unlockType:"level",unlockValue:5},ice:{id:"ice",name:"Ice",laserColor:"#00ddff",laserOpacity:.85,burstColor:"#88eeff",unlockType:"level",unlockValue:8},neon:{id:"neon",name:"Neon",laserColor:"#ff00cc",laserOpacity:.9,burstColor:"#ff44dd",unlockType:"coins",unlockValue:100},gold:{id:"gold",name:"Gold",laserColor:"#ffd700",laserOpacity:.85,burstColor:"#ffee44",unlockType:"achievement",unlockValue:"centurion"},phantom:{id:"phantom",name:"Phantom",laserColor:"#8844ff",laserOpacity:.5,burstColor:"#9966ff",unlockType:"level",unlockValue:12},electric:{id:"electric",name:"Electric",laserColor:"#4488ff",laserOpacity:.9,burstColor:"#66aaff",unlockType:"coins",unlockValue:150},rainbow:{id:"rainbow",name:"Rainbow",laserColor:"#ff0000",laserOpacity:.8,burstColor:"#ffffff",unlockType:"level",unlockValue:15,rainbow:!0}};function Ue(o,e){const t=ze[o];return!t||o==="default"?{}:{laserColor:t.laserColor||e.laserColor,laserOpacity:t.laserOpacity||e.laserOpacity,burstColor:t.burstColor}}const ue={cyber:{bassFreq:40,bassType:"sine",padFreq:220,padFilter:400,tempo:.5,arpNotes:[330,440,550,660]},sunset:{bassFreq:55,bassType:"triangle",padFreq:165,padFilter:300,tempo:.4,arpNotes:[262,330,392,440]},space:{bassFreq:30,bassType:"sine",padFreq:110,padFilter:250,tempo:.3,arpNotes:[880,1047,1175,1319]},neon:{bassFreq:80,bassType:"square",padFreq:330,padFilter:600,tempo:.7,arpNotes:[523,659,784,880]}};class Ye{constructor(){this._nodes=[],this._intervals=[],this._playing=!1,this._enabled=!0}loadSettings(){try{const e=localStorage.getItem("vr_quest_player_v2");if(e){const s=JSON.parse(e).settings||{};this._enabled=s.music!==!1}}catch{}}startMusic(e){if(!this._enabled)return;this.stopMusic();const t=_._getCtx();if(!t)return;const s=_.destination;if(!s)return;const i=ue[e]||ue.cyber;this._playing=!0;const r=t.createGain();r.gain.value=0,r.connect(s),r.gain.linearRampToValueAtTime(.08,t.currentTime+2),this._nodes.push(r),this._masterGain=r;const l=t.createOscillator(),n=t.createGain();l.type=i.bassType,l.frequency.value=i.bassFreq,n.gain.value=.4,l.connect(n).connect(r),l.start(),this._nodes.push(l,n);const h=setInterval(()=>{this._playing&&(n.gain.setValueAtTime(.4,t.currentTime),n.gain.linearRampToValueAtTime(.15,t.currentTime+1/i.tempo),n.gain.linearRampToValueAtTime(.4,t.currentTime+2/i.tempo))},2/i.tempo*1e3);this._intervals.push(h);const c=t.createOscillator(),f=t.createGain(),u=t.createBiquadFilter();c.type="sawtooth",c.frequency.value=i.padFreq,u.type="lowpass",u.frequency.value=i.padFilter,u.Q.value=2,f.gain.value=.1,c.connect(u).connect(f).connect(r),c.start(),this._nodes.push(c,f,u);const m=setInterval(()=>{if(!this._playing)return;const T=i.padFreq*(.9+Math.random()*.2);c.frequency.linearRampToValueAtTime(T,t.currentTime+2)},4e3);this._intervals.push(m);const y=setInterval(()=>{if(!this._playing)return;const T=i.arpNotes[Math.floor(Math.random()*i.arpNotes.length)],w=t.createOscillator(),M=t.createGain();w.type="sine",w.frequency.value=T,M.gain.setValueAtTime(.08,t.currentTime),M.gain.exponentialRampToValueAtTime(.001,t.currentTime+1.5),w.connect(M).connect(r),w.start(),w.stop(t.currentTime+1.5)},3/i.tempo*1e3);this._intervals.push(y)}stopMusic(){if(this._playing=!1,this._masterGain)try{const e=_._getCtx();this._masterGain.gain.linearRampToValueAtTime(0,e.currentTime+.5)}catch{}setTimeout(()=>{this._intervals.forEach(e=>clearInterval(e)),this._intervals=[],this._nodes.forEach(e=>{try{e.stop&&e.stop()}catch{}try{e.disconnect()}catch{}}),this._nodes=[],this._masterGain=null},600)}}const Q=new Ye;function je(o,e,t,s){var T;const i=o.score,r=s.targetsHit,l=s.bestCombo,n=o.shotsFired||0,h=n>0?Math.round(r/n*100):0,c=((T=e==null?void 0:e.highScores)==null?void 0:T[t.id])||0,f=i>c&&i>0,u=i-c,m=Math.floor(i/5),y=Math.floor(m*t.xpMultiplier);return{score:i,targetsHit:r,bestCombo:l,shotsFired:n,accuracy:h,isNewHigh:f,vsBest:u,xpEarned:y,modeName:t.name,modeIcon:t.icon}}function Je(o){const e=[`VR Quest | ${o.modeName}`,`Score: ${o.score.toLocaleString()} | Combo: x${o.bestCombo}`,`Accuracy: ${o.accuracy}%`];return o.isNewHigh&&e.push("New High Score!"),e.push("Can you beat my score?"),e.join(`
`)}async function We(o){try{return await navigator.clipboard.writeText(o),!0}catch{return!1}}const pe={success:{bg:"#00cc66",color:"#fff"},info:{bg:"#0088cc",color:"#fff"},warning:{bg:"#ff8800",color:"#fff"},achievement:{bg:"linear-gradient(135deg, #ffd700, #ff8c00)",color:"#000"},error:{bg:"#ff4444",color:"#fff"}};let N=null;function Ke(){return N&&document.body.contains(N)||(N=document.createElement("div"),N.className="toast-container",document.body.appendChild(N)),N}function j(o,e="info",t=3e3){const s=Ke(),i=pe[e]||pe.info,r=document.createElement("div");r.className="toast toast-enter",r.style.background=i.bg,r.style.color=i.color;const l=document.createElement("span");l.className="toast-text",l.textContent=o,r.appendChild(l);const n=document.createElement("div");n.className="toast-progress",n.style.animationDuration=`${t}ms`,r.appendChild(n),r.addEventListener("click",()=>me(r)),s.appendChild(r),requestAnimationFrame(()=>r.classList.remove("toast-enter"));const h=setTimeout(()=>me(r),t);return r._timer=h,r}function me(o){o._dismissed||(o._dismissed=!0,o._timer&&clearTimeout(o._timer),o.classList.add("toast-exit"),setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},300))}function Qe(o,e,t,s=800){if(Ze()){o.textContent=t.toLocaleString();return}const i=performance.now(),r=t-e;function l(n){const h=n-i,c=Math.min(h/s,1),f=1-Math.pow(1-c,3),u=Math.round(e+r*f);o.textContent=u.toLocaleString(),c<1&&requestAnimationFrame(l)}requestAnimationFrame(l)}function Ze(){var o;try{const e=localStorage.getItem("vr_quest_player_v2");if(e)return((o=JSON.parse(e).settings)==null?void 0:o.reducedMotion)===!0}catch{}return!1}function et(o){!navigator.xr||!o||!o.enterVR||navigator.xr.isSessionSupported("immersive-vr").then(e=>{e&&o.enterVR()}).catch(()=>{})}const tt=3;let b,B,I;window.__weaponSystem=q;function ot(){var ee;const o=document.getElementById("target-container"),e=A.current;b=new Ne(o,{spawnInterval:e.spawnInterval,maxTargets:e.maxTargets,targetLifetime:e.targetLifetime,bossMode:e.id==="bossRush"});const t=document.getElementById("hud-score"),s=document.getElementById("hud-timer"),i=document.getElementById("hud-combo"),r=document.getElementById("hud-lives"),l=document.getElementById("hud-weapon"),n=document.getElementById("hud-level"),h=document.getElementById("game-over-overlay"),c=document.getElementById("countdown-overlay"),f=document.getElementById("countdown-number");_.loadSettings();const u=new URLSearchParams(window.location.search),m=u.get("mode"),y=u.get("weapon"),T=u.get("theme");m&&A.select(m),y&&q.select(y);const w=document.getElementById("game-scene"),M=T||((ee=p.profile)==null?void 0:ee.selectedTheme)||"cyber";De(w,M),et(w),we(w);const be=fe();if(ve(be),_e(),l&&l.setAttribute("value",`${q.current.icon} ${q.current.name}`),n){const a=p.profile;a&&n.setAttribute("value",`Lv.${a.level}`)}R(),H.onChange(a=>{t.setAttribute("value",`Score: ${a}`)}),b.onComboChange=a=>{a>=2?(i.setAttribute("value",`x${a} COMBO!`),i.setAttribute("animation__pop",{property:"scale",from:"0.4 0.4 0.4",to:"0.3 0.3 0.3",dur:200,easing:"easeOutElastic"})):i.setAttribute("value","")},b.onMiss=()=>{if(A.current.lives!==1/0){const d=A.loseLife();_.playLifeLost(),R(),d&&J()}};const P=document.getElementById("btn-quit");P&&P.addEventListener("click",()=>J()),Z(),document.getElementById("btn-retry").addEventListener("click",()=>{h.classList.add("hidden");const a=A.current;b.configure({spawnInterval:a.spawnInterval,maxTargets:a.maxTargets,targetLifetime:a.targetLifetime,bossMode:a.id==="bossRush"}),A.startRound(),R(),Z()}),document.getElementById("btn-menu").addEventListener("click",()=>{window.location.href="./index.html"});function R(){if(!r)return;const a=A.lives;a===1/0?r.setAttribute("value",""):r.setAttribute("value","â™¥".repeat(Math.max(0,a)))}function _e(){var X;const a=q.current,d=p.profile,g=((X=d==null?void 0:d.weaponSkins)==null?void 0:X[a.id])||"default",C=Ue(g,a),x=C.laserColor||a.laserColor,S=C.laserOpacity||a.laserOpacity,L=document.getElementById("right-hand"),E=document.getElementById("left-hand");L&&(L.setAttribute("raycaster","lineColor",x),L.setAttribute("raycaster","lineOpacity",S)),E&&(E.setAttribute("raycaster","lineColor",x),E.setAttribute("raycaster","lineOpacity",S))}function we(a){for(let d=0;d<25;d++){const g=document.createElement("a-sphere"),C=(Math.random()-.5)*28,x=Math.random()*4+.5,S=(Math.random()-.5)*28;g.setAttribute("radius",String(.02+Math.random()*.03)),g.setAttribute("material",`shader: flat; color: #ffffff; opacity: ${.1+Math.random()*.15}`),g.setAttribute("position",`${C} ${x} ${S}`),g.setAttribute("animation",{property:"position",to:`${C+(Math.random()-.5)*2} ${x+1+Math.random()} ${S+(Math.random()-.5)*2}`,dur:6e3+Math.random()*4e3,easing:"linear",loop:!0,dir:"alternate"}),a.appendChild(g)}}function ve(a){const d=document.getElementById("crosshair");if(d){d.setAttribute("material",`shader: flat; color: ${a.crosshairColor}; opacity: 0.8`),d.setAttribute("color",a.crosshairColor);const g={small:{inner:.007,outer:.01},medium:{inner:.01,outer:.015},large:{inner:.015,outer:.022}},C=g[a.crosshairSize]||g.medium;d.setAttribute("radius-inner",String(C.inner)),d.setAttribute("radius-outer",String(C.outer))}!a.showCombo&&i&&i.setAttribute("visible","false")}function Z(){c.classList.remove("hidden");let a=tt;f.textContent=a;const d=setInterval(()=>{a--,a>0?(f.textContent=a,_.playCountdownBeep()):(f.textContent="GO!",_.playGo(),clearInterval(d),setTimeout(()=>{c.classList.add("hidden"),Ce()},500))},1e3)}document.addEventListener("shot-fired",()=>{U.state===Y.PLAYING&&H.recordShot()}),w.addEventListener("click",()=>{U.state===Y.PLAYING&&H.recordShot()});function Ce(){H.reset(),I=A.current.duration,A.startRound(),U.changeState(Y.PLAYING),P&&P.classList.remove("hidden"),b.start(),Q.loadSettings(),Q.startMusic(M),t.setAttribute("value","Score: 0"),i.setAttribute("value",""),I===1/0?(s.setAttribute("value","âˆž"),s.setAttribute("color","#44ff44")):(s.setAttribute("value",String(I)),s.setAttribute("color","#ffaa00")),R(),B&&clearInterval(B),I!==1/0&&(B=setInterval(()=>{I--,s.setAttribute("value",String(I)),I<=10?s.setAttribute("color","#ff4444"):s.setAttribute("color","#ffaa00"),I<=0&&J()},1e3))}async function J(){var se,ie;B&&clearInterval(B),P&&P.classList.add("hidden"),U.changeState(Y.GAME_OVER),b.stop(),Q.stopMusic(),_.playGameOver();const a=H.finalize(),d=A.current,g=je(a,p.profile,d,b),C=g.xpEarned,x=await p.updateHighScore(d.id,a.score),S=await p.addXp(C);await p.recordGameResult({targetsHit:b.targetsHit,bestCombo:b.bestCombo});const L=p.profile,E=q.currentId,X={...L.weaponUsage||{}};X[E]=(X[E]||0)+1;const V={...L.modeStats||{}};V[d.id]||(V[d.id]={games:0}),V[d.id].games++;const D=[...L.recentGames||[]];D.push({mode:d.id,weapon:E,score:a.score,targets:b.targetsHit,date:Date.now()}),D.length>10&&D.shift(),await p.saveProfile({weaponUsage:X,modeStats:V,recentGames:D}),x&&Xe.submitScore(d.id,a.score).catch(()=>{});const W=await Be({score:a.score,targetsHit:b.targetsHit,bestCombo:b.bestCombo,mode:d.id,weapon:E}),Te=await Ve(),k=document.getElementById("final-score");k.textContent="Score: 0",Qe(k,0,a.score,800),k.textContent;const te=new MutationObserver(()=>{k.textContent.startsWith("Score:")||(k.textContent=`Score: ${k.textContent}`)});te.observe(k,{childList:!0,characterData:!0,subtree:!0}),setTimeout(()=>{te.disconnect(),k.textContent=`Score: ${a.score.toLocaleString()}`},900);const z=document.getElementById("final-high-score");if(x)z.textContent="New High Score!",z.style.color="#ffd700";else{const v=((ie=(se=p.profile)==null?void 0:se.highScores)==null?void 0:ie[d.id])||0,O=a.score-v;z.textContent=O>=0?`High Score: ${v}`:`High Score: ${v} (${O})`,z.style.color="#888"}const F=document.getElementById("final-xp");F&&(F.textContent=`+${C} XP`,S.leveledUp?(F.textContent+=` â€” LEVEL UP! Lv.${S.newLevel}`,F.style.color="#ffd700",_.playLevelUp()):F.style.color="#00d4ff");const oe=document.getElementById("final-stats");oe&&(oe.textContent=`Targets: ${b.targetsHit} | Combo: x${b.bestCombo} | Accuracy: ${g.accuracy}%`),W.justCompleted&&j(`Challenge Complete! +${W.challenge.rewardXp} XP +${W.challenge.rewardCoins} Coins`,"success"),Te.forEach((v,O)=>{setTimeout(()=>j(`${v.icon} ${v.name} unlocked! +${v.rewardXp} XP`,"achievement"),500+O*800)}),S.leveledUp&&j(`Level Up! You are now Lv.${S.newLevel}`,"achievement");let $=document.getElementById("btn-share");if(!$){$=document.createElement("button"),$.id="btn-share",$.className="btn btn-secondary",$.textContent="Share";const v=h.querySelector(".buttons");v&&v.appendChild($)}$.onclick=async()=>{g.isNewHigh=x;const v=Je(g),O=await We(v);j(O?"Copied to clipboard!":"Could not copy",O?"success":"error")},h.classList.remove("hidden")}}let he=!1;p.waitReady().then(()=>{const o=()=>{he||(he=!0,ot())};document.addEventListener("DOMContentLoaded",o),document.readyState!=="loading"&&o()});
